define(["@grafana/data","@grafana/ui","react","@emotion/css","lodash","@grafana/runtime","rxjs"],((e,t,r,n,i,o,a)=>(()=>{"use strict";var l={644:e=>{e.exports=n},305:t=>{t.exports=e},545:e=>{e.exports=o},388:e=>{e.exports=t},980:e=>{e.exports=i},650:e=>{e.exports=r},177:e=>{e.exports=a}},s={};function c(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}};return l[e](r,r.exports,c),r.exports}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var r in t)c.o(t,r)&&!c.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},c.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{c.r(u),c.d(u,{plugin:()=>xt});var e=c(305),t=c(388),r=c(650),n=c.n(r),i=c(644);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const a=[{label:"Builder",value:"builder",component:()=>n().createElement(t.Tag,{className:(0,i.css)({fontSize:10,padding:"1px 5px",marginLeft:"5px",verticalAlign:"text-bottom"}),name:"Experimental",colorIndex:1})},{label:"Code",value:"code"}];function l(e){var r,i,{mode:l}=e,s=function(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}(e,["mode"]);return n().createElement("div",{"data-testid":"QueryEditorModeToggle"},n().createElement(t.RadioButtonGroup,(r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){o(e,t,r[t])}))}return e}({size:"sm"},s),i=null!=(i={options:a,value:l})?i:{},Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(i)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(i)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(i,e))})),r)))}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){s(e,t,r[t])}))}return e}function p(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const h=({children:e})=>{const r=(0,t.useStyles2)(f);return n().createElement("div",{className:r.root},e)},f=e=>({root:(0,i.css)({display:"flex",flexWrap:"wrap",alignItems:"center",gap:e.spacing(3),minHeight:e.spacing(4)})});var m=Object.getOwnPropertySymbols,g=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable;const v=e=>{var i=e,{children:o}=i,a=((e,t)=>{var r={};for(var n in e)g.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&m)for(var n of m(e))t.indexOf(n)<0&&y.call(e,n)&&(r[n]=e[n]);return r})(i,["children"]);const l=(0,t.useStyles2)((0,r.useCallback)((e=>b(e,a)),[a]));return n().createElement("div",{className:l.root},o)},b=(e,t)=>{var r,n,o;return{root:(0,i.css)({display:"flex",flexDirection:null!=(r=t.direction)?r:"row",flexWrap:null==(n=t.wrap)||n?"wrap":void 0,alignItems:t.alignItems,gap:e.spacing(null!=(o=t.gap)?o:2),flexGrow:t.flexGrow})}},O=({children:e})=>n().createElement(v,{gap:.5,direction:"column"},e),w=({children:e})=>n().createElement(v,{gap:1},e),_=({v:e=0,h:o=0,layout:a="block"})=>{const l=(0,t.useStyles2)((0,r.useCallback)((t=>S(t,{v:e,h:o,layout:a})),[e,o,a]));return n().createElement("span",{className:(0,i.cx)(l.wrapper)})},S=(e,t)=>{var r,n;return{wrapper:(0,i.css)([{paddingRight:e.spacing(null!=(r=t.h)?r:0),paddingBottom:e.spacing(null!=(n=t.v)?n:0)},"inline"===t.layout&&{display:"inline-block"},"block"===t.layout&&{display:"block"}])}};var j=Object.defineProperty,E=Object.getOwnPropertySymbols,P=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable,T=(e,t,r)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;const z=e=>{var i;const o=e,{label:a,optional:l,tooltip:s,tooltipInteractive:c,children:u,width:d}=o,p=((e,t)=>{var r={};for(var n in e)P.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&E)for(var n of E(e))t.indexOf(n)<0&&x.call(e,n)&&(r[n]=e[n]);return r})(o,["label","optional","tooltip","tooltipInteractive","children","width"]),h=(0,t.useStyles2)((0,r.useCallback)((e=>C(e,d)),[d])),f=(null==p?void 0:p.htmlFor)||(null==(i=t.ReactUtils)?void 0:i.getChildId(u)),m=n().createElement(n().Fragment,null,n().createElement("label",{className:h.label,htmlFor:f},a,l&&n().createElement("span",{className:h.optional}," - optional"),s&&n().createElement(t.Tooltip,{placement:"top",content:s,theme:"info",interactive:c},n().createElement(t.Icon,{tabIndex:0,name:"info-circle",size:"sm",className:h.icon}))),n().createElement(_,{v:.5}));return n().createElement("div",{className:h.root},n().createElement(t.Field,((e,t)=>{for(var r in t||(t={}))P.call(t,r)&&T(e,r,t[r]);if(E)for(var r of E(t))x.call(t,r)&&T(e,r,t[r]);return e})({className:h.field,label:m},p),u))},C=(e,t)=>({root:(0,i.css)({minWidth:e.spacing(null!=t?t:0)}),label:(0,i.css)({fontSize:12,fontWeight:e.typography.fontWeightMedium}),optional:(0,i.css)({fontStyle:"italic",color:e.colors.text.secondary}),field:(0,i.css)({marginBottom:0}),icon:(0,i.css)({color:e.colors.text.secondary,marginLeft:e.spacing(1),":hover":{color:e.colors.text.primary}})});let k;k="undefined"!=typeof window?window:"undefined"!=typeof self?self:c.g;let N=null,D=null;const F=k.clearTimeout,M=k.setTimeout,A=k.cancelAnimationFrame||k.mozCancelAnimationFrame||k.webkitCancelAnimationFrame,R=k.requestAnimationFrame||k.mozRequestAnimationFrame||k.webkitRequestAnimationFrame;null==A||null==R?(N=F,D=function(e){return M(e,20)}):(N=function([e,t]){A(e),F(t)},D=function(e){const t=R((function(){F(r),e()})),r=M((function(){A(t),e()}),20);return[t,r]});class L extends r.Component{constructor(...e){super(...e),this.state={height:this.props.defaultHeight||0,scaledHeight:this.props.defaultHeight||0,scaledWidth:this.props.defaultWidth||0,width:this.props.defaultWidth||0},this._autoSizer=null,this._detectElementResize=null,this._parentNode=null,this._resizeObserver=null,this._timeoutId=null,this._onResize=()=>{this._timeoutId=null;const{disableHeight:e,disableWidth:t,onResize:r}=this.props;if(this._parentNode){const n=window.getComputedStyle(this._parentNode)||{},i=parseFloat(n.paddingLeft||"0"),o=parseFloat(n.paddingRight||"0"),a=parseFloat(n.paddingTop||"0"),l=parseFloat(n.paddingBottom||"0"),s=this._parentNode.getBoundingClientRect(),c=s.height-a-l,u=s.width-i-o,d=this._parentNode.offsetHeight-a-l,p=this._parentNode.offsetWidth-i-o;(e||this.state.height===d&&this.state.scaledHeight===c)&&(t||this.state.width===p&&this.state.scaledWidth===u)||(this.setState({height:d,width:p,scaledHeight:c,scaledWidth:u}),"function"==typeof r&&r({height:d,scaledHeight:c,scaledWidth:u,width:p}))}},this._setRef=e=>{this._autoSizer=e}}componentDidMount(){const{nonce:e}=this.props,t=this._autoSizer?this._autoSizer.parentNode:null;if(null!=t&&t.ownerDocument&&t.ownerDocument.defaultView&&t instanceof t.ownerDocument.defaultView.HTMLElement){this._parentNode=t;const r=t.ownerDocument.defaultView.ResizeObserver;null!=r?(this._resizeObserver=new r((()=>{this._timeoutId=setTimeout(this._onResize,0)})),this._resizeObserver.observe(t)):(this._detectElementResize=function(e){let t,r,n,i,o,a,l;const s="undefined"!=typeof document&&document.attachEvent;if(!s){a=function(e){const t=e.__resizeTriggers__,r=t.firstElementChild,n=t.lastElementChild,i=r.firstElementChild;n.scrollLeft=n.scrollWidth,n.scrollTop=n.scrollHeight,i.style.width=r.offsetWidth+1+"px",i.style.height=r.offsetHeight+1+"px",r.scrollLeft=r.scrollWidth,r.scrollTop=r.scrollHeight},o=function(e){return e.offsetWidth!==e.__resizeLast__.width||e.offsetHeight!==e.__resizeLast__.height},l=function(e){if(e.target.className&&"function"==typeof e.target.className.indexOf&&e.target.className.indexOf("contract-trigger")<0&&e.target.className.indexOf("expand-trigger")<0)return;const t=this;a(this),this.__resizeRAF__&&N(this.__resizeRAF__),this.__resizeRAF__=D((function(){o(t)&&(t.__resizeLast__.width=t.offsetWidth,t.__resizeLast__.height=t.offsetHeight,t.__resizeListeners__.forEach((function(r){r.call(t,e)})))}))};let e=!1,s="";n="animationstart";const c="Webkit Moz O ms".split(" ");let u="webkitAnimationStart animationstart oAnimationStart MSAnimationStart".split(" "),d="";{const t=document.createElement("fakeelement");if(void 0!==t.style.animationName&&(e=!0),!1===e)for(let r=0;r<c.length;r++)if(void 0!==t.style[c[r]+"AnimationName"]){d=c[r],s="-"+d.toLowerCase()+"-",n=u[r],e=!0;break}}r="resizeanim",t="@"+s+"keyframes "+r+" { from { opacity: 0; } to { opacity: 0; } } ",i=s+"animation: 1ms "+r+"; "}return{addResizeListener:function(o,c){if(s)o.attachEvent("onresize",c);else{if(!o.__resizeTriggers__){const s=o.ownerDocument,c=k.getComputedStyle(o);c&&"static"===c.position&&(o.style.position="relative"),function(r){if(!r.getElementById("detectElementResize")){const n=(t||"")+".resize-triggers { "+(i||"")+'visibility: hidden; opacity: 0; } .resize-triggers, .resize-triggers > div, .contract-trigger:before { content: " "; display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; z-index: -1; } .resize-triggers > div { background: #eee; overflow: auto; } .contract-trigger:before { width: 200%; height: 200%; }',o=r.head||r.getElementsByTagName("head")[0],a=r.createElement("style");a.id="detectElementResize",a.type="text/css",null!=e&&a.setAttribute("nonce",e),a.styleSheet?a.styleSheet.cssText=n:a.appendChild(r.createTextNode(n)),o.appendChild(a)}}(s),o.__resizeLast__={},o.__resizeListeners__=[],(o.__resizeTriggers__=s.createElement("div")).className="resize-triggers";const u=s.createElement("div");u.className="expand-trigger",u.appendChild(s.createElement("div"));const d=s.createElement("div");d.className="contract-trigger",o.__resizeTriggers__.appendChild(u),o.__resizeTriggers__.appendChild(d),o.appendChild(o.__resizeTriggers__),a(o),o.addEventListener("scroll",l,!0),n&&(o.__resizeTriggers__.__animationListener__=function(e){e.animationName===r&&a(o)},o.__resizeTriggers__.addEventListener(n,o.__resizeTriggers__.__animationListener__))}o.__resizeListeners__.push(c)}},removeResizeListener:function(e,t){if(s)e.detachEvent("onresize",t);else if(e.__resizeListeners__.splice(e.__resizeListeners__.indexOf(t),1),!e.__resizeListeners__.length){e.removeEventListener("scroll",l,!0),e.__resizeTriggers__.__animationListener__&&(e.__resizeTriggers__.removeEventListener(n,e.__resizeTriggers__.__animationListener__),e.__resizeTriggers__.__animationListener__=null);try{e.__resizeTriggers__=!e.removeChild(e.__resizeTriggers__)}catch(e){}}}}}(e),this._detectElementResize.addResizeListener(t,this._onResize)),this._onResize()}}componentWillUnmount(){this._parentNode&&(this._detectElementResize&&this._detectElementResize.removeResizeListener(this._parentNode,this._onResize),null!==this._timeoutId&&clearTimeout(this._timeoutId),this._resizeObserver&&this._resizeObserver.disconnect())}render(){const{children:e,defaultHeight:t,defaultWidth:n,disableHeight:i=!1,disableWidth:o=!1,doNotBailOutOnEmptyChildren:a=!1,nonce:l,onResize:s,style:c={},tagName:u="div",...d}=this.props,{height:p,scaledHeight:h,scaledWidth:f,width:m}=this.state,g={overflow:"visible"},y={};let v=!1;return i||(0===p&&(v=!0),g.height=0,y.height=p,y.scaledHeight=h),o||(0===m&&(v=!0),g.width=0,y.width=m,y.scaledWidth=f),a&&(v=!1),(0,r.createElement)(u,{ref:this._setRef,style:{...g,...c},...d},!v&&e(y))}}var I=c(980);function V(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const $=({datasource:e,onChange:r,onRunQuery:i,query:o,payload:a})=>{const[l,s]=n().useState(),[c,u]=n().useState(null!=a?a:""),[d,p]=n().useState(null),[h,f]=n().useState([]),[m,g]=n().useState(!1),y=n().useCallback((()=>e.listMetrics("",void 0).then((e=>{const t=e.map((e=>({label:e.label,value:e.value}))),r=(0,I.find)(t,(e=>e.value===o.target));return s(void 0===r?{label:"",value:""}:r),t}),(e=>{throw s({label:"",value:""}),f([]),new Error(e.statusText)}))),[e,o.target]),v=n().useCallback((()=>{g(!0),y().then((e=>{f(e)})).finally((()=>{g(!1)}))}),[y,f,g]);return n().useEffect((()=>v()),[]),n().useEffect((()=>{var e,t;void 0!==(null==l?void 0:l.value)&&""!==(null==l?void 0:l.value)&&(null!==d&&(null==l?void 0:l.value)===d.metric&&c===d.payload||(p({payload:c,metric:l.value.toString()}),r((e=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){V(e,t,r[t])}))}return e}({},o),t=null!=(t={payload:c,target:l.value.toString()})?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e)),i()))}),[c,l]),n().createElement(n().Fragment,null,n().createElement(t.InlineFieldRow,null,n().createElement(t.InlineField,null,n().createElement(t.Select,{isLoading:m,prefix:"Metric: ",options:h,placeholder:"Select metric",allowCustomValue:!0,value:l,onChange:e=>{s(e)}}))),n().createElement(t.InlineFieldRow,null,n().createElement(L,{disableHeight:!0},(({width:e})=>n().createElement("div",{style:{width:e+"px"}},n().createElement(t.InlineLabel,null,"Payload"),n().createElement(t.CodeEditor,{width:"100%",height:"200px",language:"json",showLineNumbers:!0,showMiniMap:c.length>100,value:c,onBlur:e=>u(e)}))))))},q=(0,t.withTheme2)((({theme:e,onValueChange:t,value:r})=>{const o=(e=>{const t=function(e){return{outline:"2px dotted transparent",outlineOffset:"2px",boxShadow:`0 0 0 2px ${e.colors.background.canvas}, 0 0 0px 4px ${e.colors.primary.main}`,transitionTimingFunction:"cubic-bezier(0.19, 1, 0.22, 1)",transitionDuration:"0.2s",transitionProperty:"outline, outline-offset, box-shadow"}}(e);return{wrapper:i.css`
      &:focus-within {
        ${t}
      }
    `}})(e),a=n().useRef(void 0===r?"</div>":`<div>${r.replace(/([^\n])\n/g,"$1</div><div>").replace(/\n/g,"</div><div><br /></div><div>")}`);return n().createElement("div",{className:(0,i.cx)("slate-query-field__wrapper",o.wrapper)},n().createElement("div",{dangerouslySetInnerHTML:{__html:a.current},contentEditable:!0,style:{width:"100%",outline:"none"},onBlur:e=>{t(e.currentTarget.innerText.replace(/\n\n/g,"\n"))},onInput:e=>{a.current=e.currentTarget.innerHTML}}))}));function W(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const H=({config:e,datasource:r,query:i,onPayloadChange:o,isMulti:a,value:l})=>{const[s,c]=n().useState(),[u,d]=n().useState(!1),[p,h]=n().useState([]),f=n().useCallback((()=>{var t;return r.listMetricPayloadOptions(e.name,null!==(t=i.target)&&void 0!==t?t:"",i.payload).then((e=>{if(l){const i=r.getVariables();for(const t in i)Object.prototype.hasOwnProperty.call(i,t)&&e.push({label:`$${t}`,value:`$${t}`});if((0,I.isArray)(s))for(let t=0;t<s.length;t++)void 0!==e.find((e=>e.value===s[t].value))&&e.push({value:s[t].value,label:s[t].label});else s&&void 0!==e.find((e=>e.value===s.value))&&e.push((t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){W(e,t,r[t])}))}return e}({},s),n=null!=(n={value:s.value,label:s.label})?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})),t))}var t,n;return e}),(e=>{throw h([]),new Error(e.statusText)}))}),[r,i.payload,i.target]),m=n().useCallback((()=>{d(!0),f().then((e=>{h(e)})).finally((()=>{d(!1)}))}),[f,h,d]);var g,y;return n().useEffect((()=>{l&&m()}),[]),n().useEffect((()=>{if(l)if((0,I.isArray)(l)){const e=p.filter((e=>(0,I.includes)(l,e.value)));e?c(e):l&&c([{label:l,value:l}])}else{const e=p.find((e=>e.value===l));e?c(e):l&&c({label:l.toString(),value:l})}else c(void 0)}),[i.payload,p]),n().createElement(t.Select,{key:e.name,width:e.width,isLoading:u,prefix:e.label,options:null!==(g=e.options)&&void 0!==g?g:p,placeholder:null!==(y=e.placeholder)&&void 0!==y?y:"",allowCustomValue:!0,isClearable:!0,isMulti:a,value:s,onOpenMenu:()=>{e.options||m()},onChange:e=>{o(e)}})},B=Symbol.for("@ts-pattern/matcher"),J=Symbol.for("@ts-pattern/isVariadic"),U="@ts-pattern/anonymous-select-key",K=e=>Boolean(e&&"object"==typeof e),Q=e=>e&&!!e[B],G=(e,t,r)=>{if(Q(e)){const n=e[B](),{matched:i,selections:o}=n.match(t);return i&&o&&Object.keys(o).forEach((e=>r(e,o[e]))),i}if(K(e)){if(!K(t))return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;let n=[],i=[],o=[];for(const t of e.keys()){const r=e[t];Q(r)&&r[J]?o.push(r):o.length?i.push(r):n.push(r)}if(o.length){if(o.length>1)throw new Error("Pattern error: Using `...P.array(...)` several times in a single pattern is not allowed.");if(t.length<n.length+i.length)return!1;const e=t.slice(0,n.length),a=0===i.length?[]:t.slice(-i.length),l=t.slice(n.length,0===i.length?1/0:-i.length);return n.every(((t,n)=>G(t,e[n],r)))&&i.every(((e,t)=>G(e,a[t],r)))&&(0===o.length||G(o[0],l,r))}return e.length===t.length&&e.every(((e,n)=>G(e,t[n],r)))}return Object.keys(e).every((n=>{const i=e[n];return(n in t||Q(o=i)&&"optional"===o[B]().matcherType)&&G(i,t[n],r);var o}))}return Object.is(t,e)},Y=e=>{var t,r,n;return K(e)?Q(e)?null!=(t=null==(r=(n=e[B]()).getSelectionKeys)?void 0:r.call(n))?t:[]:Array.isArray(e)?X(e,Y):X(Object.values(e),Y):[]},X=(e,t)=>e.reduce(((e,r)=>e.concat(t(r))),[]);function Z(e){return Object.assign(e,{optional:()=>te(e),and:t=>ie(e,t),or:t=>oe(e,t),select:t=>void 0===t?le(e):le(t,e)})}function ee(e){return Object.assign((e=>Object.assign(e,{[Symbol.iterator](){let t=0;const r=[{value:Object.assign(e,{[J]:!0}),done:!1},{done:!0,value:void 0}];return{next:()=>{var e;return null!=(e=r[t++])?e:r.at(-1)}}}}))(e),{optional:()=>ee(te(e)),select:t=>ee(void 0===t?le(e):le(t,e))})}function te(e){return Z({[B]:()=>({match:t=>{let r={};const n=(e,t)=>{r[e]=t};return void 0===t?(Y(e).forEach((e=>n(e,void 0))),{matched:!0,selections:r}):{matched:G(e,t,n),selections:r}},getSelectionKeys:()=>Y(e),matcherType:"optional"})})}const re=(e,t)=>{for(const r of e)if(!t(r))return!1;return!0},ne=(e,t)=>{for(const[r,n]of e.entries())if(!t(n,r))return!1;return!0};function ie(...e){return Z({[B]:()=>({match:t=>{let r={};const n=(e,t)=>{r[e]=t};return{matched:e.every((e=>G(e,t,n))),selections:r}},getSelectionKeys:()=>X(e,Y),matcherType:"and"})})}function oe(...e){return Z({[B]:()=>({match:t=>{let r={};const n=(e,t)=>{r[e]=t};return X(e,Y).forEach((e=>n(e,void 0))),{matched:e.some((e=>G(e,t,n))),selections:r}},getSelectionKeys:()=>X(e,Y),matcherType:"or"})})}function ae(e){return{[B]:()=>({match:t=>({matched:Boolean(e(t))})})}}function le(...e){const t="string"==typeof e[0]?e[0]:void 0,r=2===e.length?e[1]:"string"==typeof e[0]?void 0:e[0];return Z({[B]:()=>({match:e=>{let n={[null!=t?t:U]:e};return{matched:void 0===r||G(r,e,((e,t)=>{n[e]=t})),selections:n}},getSelectionKeys:()=>[null!=t?t:U].concat(void 0===r?[]:Y(r))})})}function se(e){return"number"==typeof e}function ce(e){return"string"==typeof e}function ue(e){return"bigint"==typeof e}const de=Z(ae((function(e){return!0}))),pe=de,he=e=>Object.assign(Z(e),{startsWith:t=>{return he(ie(e,(r=t,ae((e=>ce(e)&&e.startsWith(r))))));var r},endsWith:t=>{return he(ie(e,(r=t,ae((e=>ce(e)&&e.endsWith(r))))));var r},minLength:t=>he(ie(e,(e=>ae((t=>ce(t)&&t.length>=e)))(t))),length:t=>he(ie(e,(e=>ae((t=>ce(t)&&t.length===e)))(t))),maxLength:t=>he(ie(e,(e=>ae((t=>ce(t)&&t.length<=e)))(t))),includes:t=>{return he(ie(e,(r=t,ae((e=>ce(e)&&e.includes(r))))));var r},regex:t=>{return he(ie(e,(r=t,ae((e=>ce(e)&&Boolean(e.match(r)))))));var r}}),fe=he(ae(ce)),me=e=>Object.assign(Z(e),{between:(t,r)=>me(ie(e,((e,t)=>ae((r=>se(r)&&e<=r&&t>=r)))(t,r))),lt:t=>me(ie(e,(e=>ae((t=>se(t)&&t<e)))(t))),gt:t=>me(ie(e,(e=>ae((t=>se(t)&&t>e)))(t))),lte:t=>me(ie(e,(e=>ae((t=>se(t)&&t<=e)))(t))),gte:t=>me(ie(e,(e=>ae((t=>se(t)&&t>=e)))(t))),int:()=>me(ie(e,ae((e=>se(e)&&Number.isInteger(e))))),finite:()=>me(ie(e,ae((e=>se(e)&&Number.isFinite(e))))),positive:()=>me(ie(e,ae((e=>se(e)&&e>0)))),negative:()=>me(ie(e,ae((e=>se(e)&&e<0))))}),ge=me(ae(se)),ye=e=>Object.assign(Z(e),{between:(t,r)=>ye(ie(e,((e,t)=>ae((r=>ue(r)&&e<=r&&t>=r)))(t,r))),lt:t=>ye(ie(e,(e=>ae((t=>ue(t)&&t<e)))(t))),gt:t=>ye(ie(e,(e=>ae((t=>ue(t)&&t>e)))(t))),lte:t=>ye(ie(e,(e=>ae((t=>ue(t)&&t<=e)))(t))),gte:t=>ye(ie(e,(e=>ae((t=>ue(t)&&t>=e)))(t))),positive:()=>ye(ie(e,ae((e=>ue(e)&&e>0)))),negative:()=>ye(ie(e,ae((e=>ue(e)&&e<0))))}),ve=ye(ae(ue)),be=Z(ae((function(e){return"boolean"==typeof e}))),Oe=Z(ae((function(e){return"symbol"==typeof e}))),we=Z(ae((function(e){return null==e}))),_e=Z(ae((function(e){return null!=e})));var Se={__proto__:null,matcher:B,optional:te,array:function(...e){return ee({[B]:()=>({match:t=>{if(!Array.isArray(t))return{matched:!1};if(0===e.length)return{matched:!0};const r=e[0];let n={};if(0===t.length)return Y(r).forEach((e=>{n[e]=[]})),{matched:!0,selections:n};const i=(e,t)=>{n[e]=(n[e]||[]).concat([t])};return{matched:t.every((e=>G(r,e,i))),selections:n}},getSelectionKeys:()=>0===e.length?[]:Y(e[0])})})},set:function(...e){return Z({[B]:()=>({match:t=>{if(!(t instanceof Set))return{matched:!1};let r={};if(0===t.size)return{matched:!0,selections:r};if(0===e.length)return{matched:!0};const n=(e,t)=>{r[e]=(r[e]||[]).concat([t])},i=e[0];return{matched:re(t,(e=>G(i,e,n))),selections:r}},getSelectionKeys:()=>0===e.length?[]:Y(e[0])})})},map:function(...e){return Z({[B]:()=>({match:t=>{if(!(t instanceof Map))return{matched:!1};let r={};if(0===t.size)return{matched:!0,selections:r};const n=(e,t)=>{r[e]=(r[e]||[]).concat([t])};if(0===e.length)return{matched:!0};var i;if(1===e.length)throw new Error(`\`P.map\` wasn't given enough arguments. Expected (key, value), received ${null==(i=e[0])?void 0:i.toString()}`);const[o,a]=e;return{matched:ne(t,((e,t)=>{const r=G(o,t,n),i=G(a,e,n);return r&&i})),selections:r}},getSelectionKeys:()=>0===e.length?[]:[...Y(e[0]),...Y(e[1])]})})},intersection:ie,union:oe,not:function(e){return Z({[B]:()=>({match:t=>({matched:!G(e,t,(()=>{}))}),getSelectionKeys:()=>[],matcherType:"not"})})},when:ae,select:le,any:de,_:pe,string:fe,number:ge,bigint:ve,boolean:be,symbol:Oe,nullish:we,nonNullable:_e,instanceOf:function(e){return Z(ae(function(e){return t=>t instanceof e}(e)))},shape:function(e){return Z(ae(function(...e){if(1===e.length){const[t]=e;return e=>G(t,e,(()=>{}))}if(2===e.length){const[t,r]=e;return G(t,r,(()=>{}))}throw new Error(`isMatching wasn't given the right number of arguments: expected 1 or 2, received ${e.length}.`)}(e)))}};const je={matched:!1,value:void 0};function Ee(e){return new Pe(e,je)}class Pe{constructor(e,t){this.input=void 0,this.state=void 0,this.input=e,this.state=t}with(...e){if(this.state.matched)return this;const t=e[e.length-1],r=[e[0]];let n;3===e.length&&"function"==typeof e[1]?n=e[1]:e.length>2&&r.push(...e.slice(1,e.length-1));let i=!1,o={};const a=(e,t)=>{i=!0,o[e]=t},l=!r.some((e=>G(e,this.input,a)))||n&&!Boolean(n(this.input))?je:{matched:!0,value:t(i?U in o?o[U]:o:this.input,this.input)};return new Pe(this.input,l)}when(e,t){if(this.state.matched)return this;const r=Boolean(e(this.input));return new Pe(this.input,r?{matched:!0,value:t(this.input,this.input)}:je)}otherwise(e){return this.state.matched?this.state.value:e(this.input)}exhaustive(){if(this.state.matched)return this.state.value;let e;try{e=JSON.stringify(this.input)}catch(t){e=this.input}throw new Error(`Pattern matching error: no pattern matches value ${e}`)}run(){return this.exhaustive()}returnType(){return this}}const xe=(0,t.stylesFactory)((({theme:e,name:r})=>{const{color:n,borderColor:o}=(0,t.getTagColorsFromName)(r),a=e.spacing.formInputHeight-8;return{itemStyle:i.css`
      display: flex;
      align-items: center;
      height: ${a}px;
      line-height: ${a-2}px;
      background-color: ${n};
      color: ${e.palette.white};
      border: 1px solid ${o};
      border-radius: 3px;
      padding: 0 ${e.spacing.xs};
      margin-right: 3px;
      white-space: nowrap;
      text-shadow: none;
      font-weight: 500;
      font-size: ${e.typography.size.sm};
    `,nameStyle:i.css`
      margin-right: 3px;
    `,buttonStyles:i.css`
      margin: 0;
      &:hover::before {
        display: none;
      }
    `}})),Te=({name:e,value:r,onRemove:i})=>{const o=(0,t.useTheme)(),a=xe({theme:o,name:e}),l=Ee(typeof r).with("string",(()=>`"${r}"`)).with("number",(()=>r)).with("boolean",(()=>r.toString())).with("object",(()=>null===r?"null":`"${JSON.stringify(r)}"`)).otherwise((()=>`"${JSON.stringify(r)}"`));return n().createElement("div",{className:a.itemStyle},n().createElement("span",{className:a.nameStyle},e,"=",l),n().createElement(t.IconButton,{name:"times",size:"lg","aria-label":`Remove ${e}`,onClick:()=>i(e),type:"button",className:a.buttonStyles}))};function ze(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ce(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){ze(e,t,r[t])}))}return e}function ke(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const Ne=e=>{const{datasource:r,onChange:i,onRunQuery:o,query:a}=e,[l,s]=n().useState();var c;const[u,d]=n().useState(null!==(c=e.payload)&&void 0!==c?c:""),[p,h]=n().useState([]),[f,m]=n().useState(null),[g,y]=n().useState([]),[v,b]=n().useState([]),[O,_]=n().useState(!1),S=n().useCallback((()=>{var e,t;return r.listMetrics(null!==(t=null!==(e=null==l?void 0:l.value)&&void 0!==e?e:a.target)&&void 0!==t?t:"",u).then((e=>{const t=(0,I.find)(e,(e=>e.value===a.target));var r;return s(void 0===t?{label:"",value:""}:{label:t.label,value:t.value}),y(null!==(r=null==t?void 0:t.payloads)&&void 0!==r?r:[]),e}),(e=>{throw s({label:"",value:""}),b([]),new Error(e.statusText)}))}),[r,u,null==l?void 0:l.value]),j=n().useCallback((()=>{_(!0),S().then((e=>{b(e)})).finally((()=>{_(!1)}))}),[S,b,_]);n().useEffect((()=>j()),[]),n().useEffect((()=>{void 0!==(null==l?void 0:l.value)&&""!==(null==l?void 0:l.value)&&(null!==f&&(null==l?void 0:l.value)===f.metric&&u===f.payload||(m({payload:u,metric:l.value.toString()}),i(ke(Ce({},a),{payload:u,target:l.value.toString()})),o()))}),[u,l]),n().useEffect((()=>{const e=[];for(const t in u)void 0===g.find((e=>e.name===t))&&e.push({name:t,value:u[t]}),h(e)}),[u,g]);const E=(e,t,n)=>{d((i=>{let o=Ce({},i);var c;return(0,I.isArray)(n)?o[e]=n.map((e=>e.value)).filter((e=>void 0!==e&&e.toString().length>0)):n&&void 0!==n.value&&""!==n.value?o[e]=n.value:delete o[e],t&&(_(!0),r.listMetrics(null!==(c=null==l?void 0:l.value)&&void 0!==c?c:"",Ce({},o)).then((e=>{const t=(0,I.find)(e,(e=>e.value===a.target));var r;s(void 0===t?{label:"",value:""}:t),y(null!==(r=null==t?void 0:t.payloads)&&void 0!==r?r:[]),b(e)}),(e=>{throw s({label:"",value:""}),b([]),new Error(e.statusText)})).finally((()=>{_(!1)}))),o}))};return n().createElement(n().Fragment,null,n().createElement(w,null,n().createElement(z,{label:"Metric"},n().createElement(t.Select,{isLoading:O,options:v,placeholder:"Select metric",allowCustomValue:!0,value:l,onOpenMenu:()=>{0===j.length&&j()},onChange:e=>{const t=v.find((t=>t.value===e.value));var r;y(null!==(r=null==t?void 0:t.payloads)&&void 0!==r?r:[]),s(e)}}))),g.length>0&&n().createElement(w,null,n().createElement(z,{label:"Payload",style:{width:"100%"}},n().createElement("div",{style:{display:"flex",flexFlow:"row wrap",gap:16,width:"100%"}},g.map((r=>{switch(r.type){case"select":case"multi-select":return n().createElement(t.InlineField,{key:r.name,style:{display:"inline-flex"}},n().createElement(H,ke(Ce({},e),{config:r,value:u[r.name],isMulti:"multi-select"===r.type,onPayloadChange:e=>{E(r.name,r.reloadMetric,e)}})));case"textarea":var i;return n().createElement(t.InlineField,{key:r.name,style:{width:"100%",display:"inline"}},n().createElement("div",{style:{width:"100%",display:"flex"}},n().createElement("label",{className:"gf-form-label"},null!==(i=r.label)&&void 0!==i?i:r.label),n().createElement(q,{config:r,value:u[r.name],onValueChange:e=>{E(r.name,r.reloadMetric,{value:e})}})));default:var o;return n().createElement(t.InlineField,{key:r.name,style:{display:"inline-flex"}},n().createElement(t.Input,{prefix:r.label,width:r.width,onBlur:e=>{E(r.name,r.reloadMetric,{value:e.currentTarget.value})},defaultValue:u[r.name],placeholder:null!==(o=r.placeholder)&&void 0!==o?o:""}))}}))))),p.length>0&&n().createElement(w,null,n().createElement(z,{label:"Unknown payload",tooltip:n().createElement(n().Fragment,null,"Payload options that are set but not defined in the ",n().createElement("code",null,"Metric.payloads"),".")},n().createElement("div",{style:{display:"flex",flexFlow:"row wrap",gap:16,width:"100%"}},p.map(((e,t)=>n().createElement(Te,{key:`${e.name}-${t}`,name:e.name,value:e.value,onRemove:()=>{E(e.name,!1,{value:""})}})))))))};function De(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Fe(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){De(e,t,r[t])}))}return e}function Me(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}function Ae(e){if(!e)return{};if("string"!=typeof e)return e;try{return JSON.parse(e)}catch(e){return console.error(e),{}}}var Re=c(545),Le=c(177);function Ie(e){return"function"==typeof e}var Ve=function(e,t){return Ve=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},Ve(e,t)};function $e(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}Ve(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function qe(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function We(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a}function He(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var Be,Je,Ue=(Be=function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}},(Je=Be((function(e){Error.call(e),e.stack=(new Error).stack}))).prototype=Object.create(Error.prototype),Je.prototype.constructor=Je,Je);function Ke(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var Qe=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}var t;return e.prototype.unsubscribe=function(){var e,t,r,n,i;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var a=qe(o),l=a.next();!l.done;l=a.next())l.value.remove(this)}catch(t){e={error:t}}finally{try{l&&!l.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}else o.remove(this);var s=this.initialTeardown;if(Ie(s))try{s()}catch(e){i=e instanceof Ue?e.errors:[e]}var c=this._finalizers;if(c){this._finalizers=null;try{for(var u=qe(c),d=u.next();!d.done;d=u.next()){var p=d.value;try{Ge(p)}catch(e){i=null!=i?i:[],e instanceof Ue?i=He(He([],We(i)),We(e.errors)):i.push(e)}}}catch(e){r={error:e}}finally{try{d&&!d.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}}if(i)throw new Ue(i)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)Ge(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(r=this._finalizers)&&void 0!==r?r:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Ke(t,e)},e.prototype.remove=function(t){var r=this._finalizers;r&&Ke(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}();function Ge(e){Ie(e)?e():e.unsubscribe()}Qe.EMPTY;var Ye={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},Xe={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=Xe.delegate;return(null==i?void 0:i.setTimeout)?i.setTimeout.apply(i,He([e,t],We(r))):setTimeout.apply(void 0,He([e,t],We(r)))},clearTimeout:function(e){var t=Xe.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function Ze(){}var et=tt("C",void 0,void 0);function tt(e,t,r){return{kind:e,value:t,error:r}}var rt=function(e){function t(t){var r,n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,((r=t)instanceof Qe||r&&"closed"in r&&Ie(r.remove)&&Ie(r.add)&&Ie(r.unsubscribe))&&t.add(n)):n.destination=ct,n}return $e(t,e),t.create=function(e,t,r){return new at(e,t,r)},t.prototype.next=function(e){this.isStopped?st(function(e){return tt("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?st(tt("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?st(et,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Qe),nt=Function.prototype.bind;function it(e,t){return nt.call(e,t)}var ot=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){lt(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){lt(e)}else lt(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){lt(e)}},e}(),at=function(e){function t(t,r,n){var i,o,a=e.call(this)||this;return Ie(t)||!t?i={next:null!=t?t:void 0,error:null!=r?r:void 0,complete:null!=n?n:void 0}:a&&Ye.useDeprecatedNextContext?((o=Object.create(t)).unsubscribe=function(){return a.unsubscribe()},i={next:t.next&&it(t.next,o),error:t.error&&it(t.error,o),complete:t.complete&&it(t.complete,o)}):i=t,a.destination=new ot(i),a}return $e(t,e),t}(rt);function lt(e){Ye.useDeprecatedSynchronousErrorHandling?(e,Ye.useDeprecatedSynchronousErrorHandling):function(e){Xe.setTimeout((function(){var t=Ye.onUnhandledError;if(!t)throw e;t(e)}))}(e)}function st(e,t){var r=Ye.onStoppedNotification;r&&Xe.setTimeout((function(){return r(e,t)}))}var ct={closed:!0,next:Ze,error:function(e){throw e},complete:Ze},ut=function(e){function t(t,r,n,i,o,a){var l=e.call(this,t)||this;return l.onFinalize=o,l.shouldUnsubscribe=a,l._next=r?function(e){try{r(e)}catch(e){t.error(e)}}:e.prototype._next,l._error=i?function(e){try{i(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,l._complete=n?function(){try{n()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,l}return $e(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;e.prototype.unsubscribe.call(this),!r&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(rt);function dt(e,t){return r=function(r,n){var i=0;r.subscribe(new ut(n,(function(r){n.next(e.call(t,r,i++))}),void 0,void 0,void 0))},function(e){if(function(e){return Ie(null==e?void 0:e.lift)}(e))return e.lift((function(e){try{return r(e,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")};var r}class pt{transformMetricFindResponse(t){const r=(0,e.toDataFrame)(t.data),n=[],i=r.fields.find((e=>"__text"===e.name)),o=r.fields.find((e=>"__value"===e.name));if(i&&o)for(let e=0;e<i.values.length;e++)n.push({text:""+i.values[e],value:""+o.values[e]});else n.push(...r.fields.flatMap((e=>e.values)).map((e=>({text:e}))));return Array.from(new Set(n.map((e=>e.text)))).map((e=>{var t;return{text:e,value:null===(t=n.find((t=>t.text===e)))||void 0===t?void 0:t.value}}))}}function ht(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ft(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){ht(e,t,r[t])}))}return e}function mt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}const gt=({onChange:e,query:i,datasource:o,range:a})=>{const[l,s]=(0,r.useState)(i),c=()=>{e(l)};return n().createElement(n().Fragment,null,n().createElement(t.InlineFieldRow,null,n().createElement(t.InlineField,{label:"Query",invalid:(e=>{if("json"===e.format){const t=(0,Re.getTemplateSrv)().replace(e.query,void 0,"json");try{JSON.parse(t)}catch(e){if(e instanceof Error&&"SyntaxError"===e.name)return!0;throw e}}return!1})(l),grow:!0},n().createElement(t.Input,{name:"query",onBlur:c,onChange:e=>s(mt(ft({},l),{query:e.currentTarget.value})),value:l.query})),n().createElement(t.InlineField,{labelWidth:14,label:"Raw JSON",tooltip:"When enabled, the query string is parsed as a JSON object. Otherwise when disabled, the query string is placed into a 'target' key to create a JSON object."},n().createElement(t.InlineSwitch,{name:"format",onBlur:c,onChange:e=>s(mt(ft({},l),{format:e.currentTarget.checked?"json":"string"})),value:(u=l.format,"json"===u)}))));var u},yt=(e,t)=>(t.credentials=e.withCredentials?"include":"same-origin",t.headers=e.headers,(0,Re.getBackendSrv)().fetch(t));function vt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class bt{process(t=(0,e.getDefaultTimeRange)()){return(0,Le.lastValueFrom)(yt(this.datasource,{url:`${this.datasource.url}/variable`,data:{payload:this.query,range:t},method:"POST"}).pipe(dt((e=>this.responseParser.transformMetricFindResponse(e)))))}constructor(t,r){vt(this,"datasource",void 0),vt(this,"query",void 0),vt(this,"range",void 0),vt(this,"responseParser",void 0),this.datasource=t,this.query=r,this.datasource=t,this.query=r,this.range=(0,e.getDefaultTimeRange)(),this.responseParser=new pt}}function Ot(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class wt extends e.CustomVariableSupport{query(t){const r=(t.targets[0],t.targets[0]);if(!r)return(0,Le.of)({data:[]});const n=(a=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){Ot(e,t,r[t])}))}return e}({},t.scopedVars),l=null!=(l={__interval:{text:this.datasource.interval,value:this.datasource.interval},__interval_ms:void 0===this.datasource.interval?void 0:{text:e.rangeUtil.intervalToMs(this.datasource.interval),value:e.rangeUtil.intervalToMs(this.datasource.interval)}})?l:{},Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(l)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(l)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(l,e))})),a),i="json"===r.format?JSON.parse(this.templateSrv.replace(r.query,n,"json")):{target:this.templateSrv.replace(r.query,n,"regex")},o=new bt(this.datasource,i);var a,l;return(0,Le.from)(o.process(t.range)).pipe(dt((e=>({data:e}))))}constructor(e,t=(0,Re.getTemplateSrv)()){super(),Ot(this,"datasource",void 0),Ot(this,"templateSrv",void 0),Ot(this,"editor",void 0),this.datasource=e,this.templateSrv=t,this.editor=gt}}function _t(e,t,r,n,i,o,a){try{var l=e[o](a),s=l.value}catch(e){return void r(e)}l.done?t(s):Promise.resolve(s).then(n,i)}function St(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function jt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){St(e,t,r[t])}))}return e}function Et(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r}(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})),e}class Pt extends e.DataSourceApi{query(t){const r=this.processTargets(t);return r.targets=r.targets.filter((e=>!e.hide)),0===r.targets.length?Promise.resolve({data:[]}):(t.scopedVars=jt({},this.getVariables(),t.scopedVars),(0,Le.lastValueFrom)(yt(this,{url:`${this.url}/query`,data:r,method:"POST"}).pipe(dt((t=>(t.data=t.data.map(e.toDataFrame),t))))))}testDatasource(){var e,t=this;return(e=function*(){const e="Data source is not working";try{const r=yield(0,Le.lastValueFrom)(yt(t,{url:t.url,method:"GET"}).pipe(dt((e=>e))));return 200===r.status?{status:"success",message:"Data source is working",title:"Success"}:{message:r.statusText?r.statusText:e,status:"error",title:"Error"}}catch(t){var r,n;if("string"==typeof t)return{status:"error",message:t};let o=t;var i;let a=null!==(i=o.statusText)&&void 0!==i?i:e;return void 0!==(null===(n=o.data)||void 0===n||null===(r=n.error)||void 0===r?void 0:r.code)&&(a+=`: ${o.data.error.code}. ${o.data.error.message}`),{status:"error",message:a,title:"Error"}}},function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function a(e){_t(o,n,i,a,l,"next",e)}function l(e){_t(o,n,i,a,l,"throw",e)}a(void 0)}))})()}metricFindQuery(e,t){const r="json"===e.format?JSON.parse((0,Re.getTemplateSrv)().replace(e.query,void 0,"json")):{target:(0,Re.getTemplateSrv)().replace(e.query,void 0,"regex")};return new bt(this,r).process(null==t?void 0:t.range)}listMetricPayloadOptions(e,t,r){return(0,Le.lastValueFrom)(yt(this,{url:`${this.url}/metric-payload-options`,data:{metric:t,payload:this.processPayload(r,"builder",void 0),name:e},method:"POST"}).pipe(dt((e=>(0,I.isArray)(e.data)?e.data.map((e=>Et(jt({},e),{label:e.label?e.label:e.value}))):[]))))}listMetrics(e,t){return(0,Le.lastValueFrom)(yt(this,{url:`${this.url}/metrics`,data:{metric:e.toString()?(0,Re.getTemplateSrv)().replace(e.toString(),void 0,"regex"):void 0,payload:t?this.processPayload(t,"builder",void 0):void 0},method:"POST"}).pipe(dt((e=>(0,I.isArray)(e.data)?e.data.map((e=>{return"string"==typeof e?{value:e,label:e,payloads:[]}:Et(jt({},e),{payloads:(0,I.isArray)(e.payloads)?e.payloads.map((e=>Et(jt({},e),{label:e.label?e.label:e.name}))):[],label:null!==(t=e.label)&&void 0!==t?t:e.value});var t})):[]))))}getTagKeys(e){return(0,Le.lastValueFrom)(yt(this,{url:`${this.url}/tag-keys`,method:"POST",data:e}).pipe(dt((e=>e.data))))}getTagValues(e){return(0,Le.lastValueFrom)(yt(this,{url:`${this.url}/tag-values`,method:"POST",data:e}).pipe(dt((e=>e.data))))}mapToTextValue(e){return e.data.map(((e,t)=>e&&e.text&&e.value?{text:e.text,value:e.value}:(0,I.isObject)(e)?{text:e,value:t}:{text:e,value:e}))}processPayload(e,t,r){try{if("string"==typeof e&&"builder"!==t)return""!==e.trim()?JSON.parse(e.replace((0,Re.getTemplateSrv)().regex,(e=>this.cleanMatch(e,{scopedVars:r})))):{};{const t="string"==typeof e?JSON.parse(e):jt({},e);for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){const n=t[e];(0,I.isArray)(n)?t[e]=n.map((e=>(0,Re.getTemplateSrv)().replace(e.toString(),r,"regex"))):t[e]=(0,Re.getTemplateSrv)().replace(t[e].toString(),r,"regex")}return t}}catch(e){return{}}}processTarget(e,t){const r=jt({},e);var n;return r.payload=this.processPayload(null!==(n=r.payload)&&void 0!==n?n:"",r.editorMode,t),"string"==typeof r.target&&(r.target=(0,Re.getTemplateSrv)().replace(r.target.toString(),t,"regex")),r}processTargets(e){return e.targets=e.targets.filter((e=>void 0!==e.target)).map((t=>this.processTarget(t,e.scopedVars))),e}cleanMatch(e,t){const r=(0,Re.getTemplateSrv)().replace(e,t.scopedVars,"json");return'"'===r[0]&&'"'===r[r.length-1]?JSON.parse(r):r}getVariables(){const e={};return Object.values((0,Re.getTemplateSrv)().getVariables()).forEach((t=>{if("adhoc"===t.type)return;if("system"===t.type)return;const r=Ee(t).with({type:Se.union("custom","query")},(e=>(e=>{let t=e.current.value;return("$__all"===t||(0,I.isEqual)(t,["$__all"]))&&(t=null===e.allValue||""===e.allValue||void 0===e.allValue?e.options.slice(1).map((t=>{if("string"!=typeof t.value){const r=new Error("Variable option value is not a string");throw console.error(r.message,t,e),r}return t.value})):e.allValue),t})(e))).with({type:Se.union("constant","datasource","groupby","interval","textbox")},(e=>e.current.value)).exhaustive();void 0!==r&&(e[t.id]={selected:!1,text:t.current.text,value:r})})),e}constructor(e,t=(0,Re.getTemplateSrv)()){var r,n;super(e),St(this,"templateSrv",void 0),St(this,"url",void 0),St(this,"withCredentials",void 0),St(this,"headers",void 0),St(this,"responseParser",void 0),St(this,"defaultEditorMode",void 0),St(this,"annotations",void 0),this.templateSrv=t,this.annotations={},this.responseParser=new pt,this.defaultEditorMode=null!==(n=null===(r=e.jsonData)||void 0===r?void 0:r.defaultEditorMode)&&void 0!==n?n:"code",this.url=void 0===e.url?"":e.url,this.variables=new wt(this,this.templateSrv),this.withCredentials=void 0!==e.withCredentials,this.headers={"Content-Type":"application/json"},"string"==typeof e.basicAuth&&e.basicAuth.length>0&&(this.headers.Authorization=e.basicAuth)}}const xt=new e.DataSourcePlugin(Pt).setConfigEditor((({options:e,onOptionsChange:r})=>{var i;return n().createElement(n().Fragment,null,n().createElement(t.DataSourceHttpSettings,{defaultUrl:"http://localhost:8080",dataSourceConfig:e,showAccessOptions:!0,onChange:r}),n().createElement("h3",{className:"page-heading"},"Other"),n().createElement("div",{className:"gf-form-group"},n().createElement("div",{className:"gf-form-inline"},n().createElement("div",{className:"gf-form"},n().createElement(t.Field,{label:"Default edit mode"},n().createElement(l,{size:"md",mode:null!==(i=e.jsonData.defaultEditorMode)&&void 0!==i?i:"code",onChange:t=>{r(p(d({},e),{jsonData:p(d({},e.jsonData),{defaultEditorMode:t})}))}}))))))})).setQueryEditor((e=>{const{onChange:i,query:o,datasource:a}=e,{defaultEditorMode:s}=a,c=o.editorMode,[u,d]=n().useState(!1);n().useEffect((()=>{var e;i(Me(Fe({},o),{editorMode:null!==(e=o.editorMode)&&void 0!==e?e:s}))}),[]);const p=(0,r.useCallback)((e=>{i(Me(Fe({},o),{editorMode:e}))}),[i,o]);return n().createElement(n().Fragment,null,n().createElement(h,null,n().createElement(t.InlineField,{label:"Mode"},n().createElement(l,{size:"md",mode:c,onChange:p})),n().createElement(t.InlineField,{label:"Raw query"},n().createElement(t.InlineSwitch,{sizes:"md",label:"Raw query",value:u,onChange:e=>d(e.currentTarget.checked)}))),n().createElement(O,null,"code"===(null!=c?c:s)&&n().createElement($,Me(Fe({},e),{payload:(f=o.payload,"string"==typeof f?f:f?JSON.stringify(f,void 0,2):"")})),"builder"===(null!=c?c:s)&&n().createElement(Ne,Me(Fe({},e),{payload:Ae(o.payload)}))),u&&n().createElement(w,null,n().createElement(z,{label:"Raw query",width:"100%",style:{width:"100%"}},n().createElement(L,{disableHeight:!0},(({width:e})=>n().createElement("div",{style:{width:e+"px"}},n().createElement(t.CodeEditor,{width:"100%",height:"200px",readOnly:!0,value:JSON.stringify(a.processTarget(o),void 0,2),onBlur:()=>{},language:"json"})))))));var f}))})(),u})()));
//# sourceMappingURL=module.js.map